# Perfetto UI 代码讲解（给领导汇报用）

## 一、我今天要讲的内容

我会从四个方面把 Perfetto UI 讲清楚，方便后续我们基于这个架构做开发：

1. UI 的入口在哪里，入口做了什么

2. 整体架构是怎么设计的

3. 页面是怎么实现、怎么注册、怎么渲染的

4. 以后我们怎么基于这个架构做开发

---

## 二、UI 入口在哪里？入口干了什么？

### 1. 核心入口文件：ui/src/frontend/ui_main.ts

这是整个 Perfetto UI 的“根组件”，所有界面都是从这里开始渲染的，相当于整个 UI 的“入口大门 + 骨架组装工厂”。

### 2. 入口文件主要做了 4 件核心事

#### （1）组装整个 UI 的骨架

它把 UI 所有核心部件拼在一起，形成完整的界面框架：

- 左侧侧边栏（Sidebar）：放页面导航菜单

- 顶部导航栏（Topbar）：放 Trace 导入、搜索、设置等功能

- 中间页面容器：根据用户点击的菜单，显示对应的页面内容

- 底部状态栏（StatusBar）：显示加载状态、查询耗时等信息

- 全局弹窗（Modal）：处理错误提示、确认操作等

- 加载进度条（LinearProgress）：显示任务加载状态

一句话总结：ui_main.ts 就是把整个 UI 的“架子”搭起来的核心文件。

#### （2）管理全局加载状态

它会实时监听三个关键状态，只要有一个在忙，就显示顶部的加载进度条：

- Trace 文件是否正在加载

- SQL 查询是否还在执行

- 其他异步任务是否未完成

#### （3）更新浏览器标题

根据当前打开的 Trace 文件名称，动态修改浏览器标签页的标题，比如打开“test.trace”，标题就会变成“test.trace - Perfetto UI”，方便用户识别。

#### （4）初始化 CSS 常量

把页面的 CSS 样式变量（比如颜色、间距）同步到 JS 代码里，保证整个 UI 的样式统一，不会出现错乱。

---

## 三、整体架构设计是怎样的？

Perfetto UI 最核心的设计是「插件化架构 + 分层设计」，这种设计的好处是扩展性强、维护方便，核心代码和业务代码不会混在一起。

### 1. 分层结构（从下到上，清晰明了）

#### （1）core 层（核心层）—— 框架基础

负责最底层的核心能力，不涉及具体 UI 展示：

- 应用状态管理（比如当前打开的 Trace、路由信息）

- Trace 数据封装（把 Trace 数据、查询引擎打包成统一的对象）

- 插件系统（管理所有插件的加载、注销）

- 路由管理（监听用户点击，匹配对应的页面）

#### （2）public 层（接口层）—— 开发规范

定义好开发插件、页面需要遵守的“规则”（接口），相当于给我们开发人员的“说明书”：

- PageManager：用于注册页面的接口

- PerfettoPlugin：开发插件必须实现的接口

- Trace：操作 Trace 数据的接口

#### （3）frontend 层（UI 骨架层）—— 界面外壳

就是我们前面说的“UI 架子”，包含：

- ui_main.ts（入口文件）

- sidebar.ts（侧边栏）、topbar.ts（顶部栏）、statusbar.ts（状态栏）

#### （4）plugins 层（业务页面层）—— 具体功能

所有我们能看到的具体页面，都是一个独立的“插件”，比如：

- Insights 分析页面

- Trace 信息展示页面

- PProf 火焰图分析页面

关键优势：新增页面不用改核心代码，只需要加一个插件就行。

#### （5）widgets 层（通用 UI 组件层）—— 基础零件

存放所有页面都会用到的通用组件，比如按钮、表格、输入框、弹窗等，避免重复开发。

---

## 四、页面是怎么实现的？怎么注册？怎么渲染？

Perfetto UI 的页面不是写死在核心代码里的，而是通过「插件注册」的方式加入系统的，流程非常灵活。

### 1. 核心逻辑：页面 = 独立插件

想新增一个页面，完全不用修改 core、frontend 这些核心层的代码，只需要开发一个插件，然后把插件“注册”到系统里就行，不会影响现有功能。

### 2. 页面注册的简单示例（伪代码）

只需要做两件事，就能把新页面加入系统：

```typescript
// 1. 注册页面路由：告诉系统 “/insights” 这个路径对应哪个页面
trace.pages.registerPage({
  route: "/insights", // 页面路径
  render: () => m(InsightsPage, { trace }), // 渲染对应的页面组件
});

// 2. 往侧边栏加菜单：让用户能点击找到这个页面
trace.sidebar.addMenuItem({
  text: "Insights", // 菜单文字
  href: "#!/insights", // 点击后跳转的路径
});
```

### 3. 页面渲染流程（用户点击后发生了什么）

1. 用户点击侧边栏的“Insights”菜单

2. 浏览器 URL 变成 “#!/insights”

3. 路由系统解析出路径 “/insights”

4. PageManager 找到之前注册的 Insights 页面插件

5. 调用插件的渲染方法，生成页面内容

6. 把生成的内容放到 ui_main.ts 里的“页面容器”中，用户就能看到页面了

一句话总结：页面渲染是“用户点击 → 路由匹配 → 插件渲染”的模式，逻辑很清晰。

---

## 五、以后我们怎么基于这个架构做开发？

基于这个插件化架构，我们后续开发非常规范，我总结了 3 个核心要点：

### 1. 新增页面 = 开发一个插件（最常用场景）

步骤固定，不会乱：

1. 在 ui/src/plugins/ 目录下，新建一个自己的插件目录（比如 ui/src/plugins/our-custom-page/）

2. 实现 PerfettoPlugin 接口（按照 public 层的规则来写）

3. 在插件的 onTraceLoad 方法里，注册页面路由和侧边栏菜单（参考前面的伪代码）

4. 开发页面组件（用 Mithril 框架，和现有页面风格保持一致）

5. 编译项目，新页面就会出现在系统里了

优势：多个开发同时做不同页面，互相不干扰，不会改乱核心代码。

### 2. 扩展现有功能 = 写插件或扩展 widgets

- 想加一个新的分析工具（比如新的 Trace 数据分析功能）：开发一个新插件

- 想加一个新的 UI 组件（比如特殊的图表）：扩展 widgets 层，新增一个通用组件

- 想加全局功能（比如全局搜索优化）：可以修改 topbar 等骨架文件，但尽量少改，优先用插件实现

### 3. 与 Trace 数据交互 = 调用 trace 对象的方法

所有页面插件都能直接拿到 trace 对象，想查询 Trace 数据，直接调用它的方法就行：

```typescript
// 执行 SQL 查询 Trace 数据，拿到结果后展示在页面上
const result = await trace.engine.query("SELECT * FROM slice");
```

---

## 六、总结（核心结论）

Perfetto UI 的设计非常适合我们后续开发和维护，核心特点有 6 个：

1. 入口清晰：就一个核心入口文件 ui_main.ts，负责搭 UI 架子

2. 架构分层明确：core → public → frontend → plugins → widgets，每层职责清晰，不会混乱

3. 页面插件化：所有业务页面都是独立插件，扩展方便，不影响核心代码

4. 路由驱动渲染：用户操作和页面展示的逻辑对应关系清晰，容易理解

5. 开发门槛低：新增页面只需按规则写插件，不用熟悉整个核心框架

6. 适合团队协作：多个开发可以并行开发不同插件，互相不干扰

后续我们开发新功能、新页面，都可以按照这个插件化的思路来做，高效又安全。
